<htmL>

<head>
    <meta charset="UTF-8">
    <title>Impaird Driving Death Rate by Age, Gender, and State</title>
    <script type="text/javascript" src="libraries/d3.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script type="text/javascript" src="libraries/d3-legend-2.24.0/d3-legend.js"></script> 

    <!-- removes any default padding and style -->
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        h1 {
            font-family: arial;
            font-size: 1em;
            color: #333;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        .states {
            fill: #e5e5e5;
            stroke: #fff;
            stroke-width: 2px;
        }

        .states:hover {
            fill: steelblue;
        }
    </style>
</head>

<body>
    <div id="info">
        <h1 id="name"></h1>
    </div>
    <script>
        /* Final d3 Assignment
		* Peter Thung, Daniel Vance
        * Sources:
        *   Map Data -> http://bl.ocks.org/mapsam/6083585
        *   Impaired driving data -> https://www.cdc.gov/motorvehiclesafety/impaired_driving/states-data-tables.html
        *   Added fill color to choropleth map, based on % driving death rate.
        *   Added threshold legend utilzing http://d3-legend.susielu.com/#color-threshold
        *           Note: there was an issue with .useClass(true) method, making
        *                 the squares in the legend all black.
		*/
        var w = 960,
            h = 500,
            deathRateFlag = true;

        var threshold = [1, 3, 6, 9, 12];
        var colorRange = ["#f2f0f7", "#dadaeb", "#bcbddc",
                "#9e9ac8", "#756bb1", "#54278f"];

        var colorScale = d3.scaleThreshold()
            .domain(threshold) // currently needed to manually deterine domain by hand based on data.
            .range(colorRange);
              

        var svg = d3.select("body").append("svg")
            .attr("width", w)
            .attr("height", h)
            .attr("style", "border: 2px solid #aaaaaa;")

        // append legend Threshold
        svg.append("g")
          .attr("class", "legendThreshold")
          .attr("transform", "translate(770,350)");

        var legendThreshold = d3.legendColor()
            .labelFormat(d3.format(".2f"))
            .labels(d3.legendHelpers.thresholdLabels)
            .useClass(false) /// this was originall true, needed to make it false to work.
            .scale(colorScale);

        svg.select(".legendThreshold")
            .call(legendThreshold);    


        // end append legend

        var projection = d3.geoAlbersUsa()
            .scale(1000)
            .translate([w / 2, h / 2]);

        var path = d3.geoPath(projection);

        var geoProjection = d3.geoConicEqualArea()
            .scale(1000)
            .translate([w / 2, h / 2]);

        function getStatePrevalence(state, impairedData) {
            for (var i = 0; i < impairedData.length; i++) {
                if (state == impairedData[i].State) {
                    return impairedData[i]["Prevalence"];
                }
            }
        }

        function getStateDeathRate(state, impairedData) {
            for (var i = 0; i < impairedData.length; i++) {
                if (state == impairedData[i].State) {
                    return impairedData[i]["Impaired Driving Death Rate"];
                }
            }
        }

        d3.csv("data/impaired-driving-prevalence-2012-all-states.csv", function (error, prevalenceData) {
            if (error) return console.warn(error);
            d3.csv("data/impaireddrivingdeathrate.csv", function (error, deathRateData) {
                if (error) return console.warn(error);

                d3.json("data/us.json", function (error, us) {
                    if (error) throw error;

                    svg.selectAll('.states')
                        .data(topojson.feature(us, us.objects.usStates).features)
                        .enter()
                        .append('path')
                        .attr("class", "states")
                        .attr('d', path)
                        .style("fill", function (d) {
                            var name = d.properties.STATE_ABBR;
                            var stats;
                            if (deathRateFlag) {
                                stats = getStateDeathRate(name, deathRateData);
                            } else {
                                stats = getStatePrevalence(name, prevalenceData);
                            }
                            var colorValue = colorScale(stats);
                            return colorScale(stats); // <-D
                        })
                        .on('mouseover', function (d) {
                            svg.selectAll("incidents").remove();
                            var name = d.properties.STATE_ABBR;
                            var prevalence = getStatePrevalence(name, prevalenceData),
                                deathRate = getStateDeathRate(name, deathRateData);
                            if (!prevalence) prevalence = 0;
                            if (!deathRate) deathRate = 0;

                            return document.getElementById('name').innerHTML = name + ": </br>Prevalence: " + prevalence
                                                                               + "%</br>Death Rate: " + deathRate + "%";
                        });
                });
            });
        });
    </script>

</body>


</html>
